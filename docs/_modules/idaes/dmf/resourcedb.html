

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>idaes.dmf.resourcedb &mdash; IDAES v1.0.0</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/idaes-logo.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/theme_and_schema.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> IDAES
          

          
            
            <img src="../../../_static/idaes-logo-100x100.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../standards.html">IDAES Modeling Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core/index.html">Core Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../models/index.html">Unit Model Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../property_models/index.html">Property Model Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dmf/index.html">Data Management Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version.html">IDAES versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Tutorials</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">IDAES</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>idaes.dmf.resourcedb</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for idaes.dmf.resourcedb</h1><div class="highlight"><pre>
<span></span><span class="c1">##############################################################################</span>
<span class="c1"># Institute for the Design of Advanced Energy Systems Process Systems</span>
<span class="c1"># Engineering Framework (IDAES PSE Framework) Copyright (c) 2018, by the</span>
<span class="c1"># software owners: The Regents of the University of California, through</span>
<span class="c1"># Lawrence Berkeley National Laboratory,  National Technology &amp; Engineering</span>
<span class="c1"># Solutions of Sandia, LLC, Carnegie Mellon University, West Virginia</span>
<span class="c1"># University Research Corporation, et al. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Please see the files COPYRIGHT.txt and LICENSE.txt for full copyright and</span>
<span class="c1"># license information, respectively. Both files are also available online</span>
<span class="c1"># at the URL &quot;https://github.com/IDAES/idaes&quot;.</span>
<span class="c1">##############################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Resource database.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># system</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="c1"># third party</span>
<span class="kn">import</span> <span class="nn">pendulum</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">tinydb</span> <span class="k">import</span> <span class="n">TinyDB</span><span class="p">,</span> <span class="n">Query</span>
<span class="c1"># local</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">.resource</span> <span class="k">import</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">.resource</span> <span class="k">import</span> <span class="n">Triple</span><span class="p">,</span> <span class="n">triple_from_resource_relations</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Dan Gunter &lt;dkgunter@lbl.gov&gt;&#39;</span>

<span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ResourceDB"><a class="viewcode-back" href="../../../apidoc/idaes.dmf.resourcedb.html#idaes.dmf.resourcedb.ResourceDB">[docs]</a><span class="k">class</span> <span class="nc">ResourceDB</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A database interface to all the resources within a given DMF workspace.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize from DMF and given configuration field.</span>

<span class="sd">        Args:</span>
<span class="sd">            dbfile (str): DB location</span>
<span class="sd">            connection: If non-empty, this is an</span>
<span class="sd">                existing connection that should be re-used, instead of</span>
<span class="sd">                trying to connect to the location in `dbfile`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError, if dbfile</span>
<span class="sd">             and connection are both None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">connection</span>
        <span class="k">elif</span> <span class="n">dbfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">TinyDB</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">FileError</span><span class="p">(</span><span class="s1">&#39;Cannot open resource DB &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span>
                                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbfile</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>

<div class="viewcode-block" id="ResourceDB.find"><a class="viewcode-back" href="../../../apidoc/idaes.dmf.resourcedb.html#idaes.dmf.resourcedb.ResourceDB.find">[docs]</a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_dict</span><span class="p">,</span> <span class="n">id_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find and return records based on the provided filter.</span>

<span class="sd">        Args:</span>
<span class="sd">            filter_dict (dict): Search filter. For syntax, see docs in</span>
<span class="sd">                                :meth:`.dmf.DMF.find`.</span>
<span class="sd">            id_only (bool): If true, return only the identifier of each</span>
<span class="sd">                resource; otherwise a Resource object is returned.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (list of int|Resource) Depending on the value of `id_only`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">as_resource</span><span class="p">(</span><span class="n">_r</span><span class="p">):</span>
            <span class="n">rsrc</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">_r</span><span class="p">)</span>
            <span class="n">rsrc</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;doc_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_r</span><span class="o">.</span><span class="n">doc_id</span>
            <span class="k">return</span> <span class="n">rsrc</span>
        <span class="c1"># with no filter, do a find-all</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filter_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">id_only</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">r</span><span class="o">.</span><span class="n">eid</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">as_resource</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">filter_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_expr</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">)</span>

        <span class="c1"># return results for query</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Find resources matching: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">id_only</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">r</span><span class="o">.</span><span class="n">eid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">as_resource</span><span class="p">(</span><span class="n">r</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_create_filter_expr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filter_dict</span><span class="p">):</span>
        <span class="c1"># convert filter to expression for TinyDB</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span>
        <span class="n">filter_expr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">fadd</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Update filter, or set to 1st condition, &amp; return new value.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">c</span> <span class="k">if</span> <span class="n">filter_expr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">filter_expr</span> <span class="o">&amp;</span> <span class="n">c</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># XXX: Issue a warning?</span>
            <span class="c1"># strip off list-query operator</span>
            <span class="n">qry_all</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">):</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">qry_all</span> <span class="o">=</span> <span class="n">k</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span>
            <span class="c1"># Get the query[field1][field2][..][fieldN] object</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="n">q</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">qry</span> <span class="o">=</span> <span class="n">qry</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="c1"># A list value means find these value(s) in the</span>
            <span class="c1"># list value of the record. By default, any matching</span>
            <span class="c1"># value is a match. If the key has a &#39;!&#39; appended, then</span>
            <span class="c1"># require all values for a match.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">qry_all</span><span class="p">:</span>
                    <span class="n">cond</span> <span class="o">=</span> <span class="n">qry</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cond</span> <span class="o">=</span> <span class="n">qry</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="n">filter_expr</span> <span class="o">=</span> <span class="n">fadd</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># There are two types of non-list values:</span>
                <span class="c1"># - equality is just {key: value}</span>
                <span class="c1"># - inequalities are {key: {op: value, ...}}</span>
                <span class="c1">#   operators are &quot;$&lt;shell test op&gt;&quot;, such as &quot;$lt&quot;,</span>
                <span class="c1">#   just like in MongoDB; see _op_cond() method for details.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">op_key</span><span class="p">,</span> <span class="n">op_value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                        <span class="n">tv</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_value_transform</span><span class="p">(</span><span class="n">op_value</span><span class="p">)</span>
                        <span class="n">cond</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_op_cond</span><span class="p">(</span><span class="n">qry</span><span class="p">,</span> <span class="n">op_key</span><span class="p">,</span> <span class="n">tv</span><span class="p">)</span>
                        <span class="n">filter_expr</span> <span class="o">=</span> <span class="n">fadd</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">cond</span> <span class="o">=</span> <span class="n">qry</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                    <span class="n">filter_expr</span> <span class="o">=</span> <span class="n">fadd</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">cond</span> <span class="o">=</span> <span class="o">~</span> <span class="n">qry</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                    <span class="n">filter_expr</span> <span class="o">=</span> <span class="n">fadd</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_value_transform</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">cond</span> <span class="o">=</span> <span class="n">qry</span> <span class="o">==</span> <span class="n">tv</span>
                    <span class="n">filter_expr</span> <span class="o">=</span> <span class="n">fadd</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filter_expr</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_value_transform</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">Pendulum</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">pv</span> <span class="o">=</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                                     <span class="n">v</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">microsecond</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">tzname</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pv</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">return</span> <span class="n">pv</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_op_cond</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># just a clumsy switch statement..</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;$gt&#39;</span><span class="p">:</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="n">query</span> <span class="o">&gt;</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;$ge&#39;</span><span class="p">:</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="n">query</span> <span class="o">&gt;=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;$lt&#39;</span><span class="p">:</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="n">query</span> <span class="o">&lt;</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;$le&#39;</span><span class="p">:</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="n">query</span> <span class="o">&lt;=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;$ne&#39;</span><span class="p">:</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="n">query</span> <span class="o">!=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected operator: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cond</span>

<div class="viewcode-block" id="ResourceDB.find_one"><a class="viewcode-back" href="../../../apidoc/idaes.dmf.resourcedb.html#idaes.dmf.resourcedb.ResourceDB.find_one">[docs]</a>    <span class="k">def</span> <span class="nf">find_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Same as `find()`, but returning only first value or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">break</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="ResourceDB.find_related"><a class="viewcode-back" href="../../../apidoc/idaes.dmf.resourcedb.html#idaes.dmf.resourcedb.ResourceDB.find_related">[docs]</a>    <span class="k">def</span> <span class="nf">find_related</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">,</span> <span class="n">filter_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outgoing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">maxdepth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find all resources connected to the identified one.</span>

<span class="sd">        Args:</span>
<span class="sd">            id_ (str): Unique ID of target resource.</span>
<span class="sd">            filter_dict (dict): Filter to these resources</span>
<span class="sd">            outgoing:</span>
<span class="sd">            maxdepth:</span>
<span class="sd">            meta (List[str]): Metadata fields to extract</span>
<span class="sd">        Returns:</span>
<span class="sd">            Generator of (depth, relation, metadata)</span>
<span class="sd">        Raises:</span>
<span class="sd">            KeyError if the resource is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">maxdepth</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">maxdepth</span> <span class="o">=</span> <span class="mi">9223372036854775807</span>
        <span class="c1"># Get an iterator over all the resources, optionally</span>
        <span class="c1"># filtered by an expression, as for find().</span>
        <span class="k">if</span> <span class="n">filter_dict</span><span class="p">:</span>
            <span class="n">filter_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_expr</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">)</span>
            <span class="n">resource_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resource_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="c1"># build adjacency list representing connections between resources</span>
        <span class="n">relation_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">rsrc</span> <span class="ow">in</span> <span class="n">resource_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rrel</span> <span class="ow">in</span> <span class="n">rsrc</span><span class="p">[</span><span class="s1">&#39;relations&#39;</span><span class="p">]:</span>
                <span class="n">uuid</span> <span class="o">=</span> <span class="n">rsrc</span><span class="p">[</span><span class="n">Resource</span><span class="o">.</span><span class="n">ID_FIELD</span><span class="p">]</span>
                <span class="n">rel</span> <span class="o">=</span> <span class="n">triple_from_resource_relations</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">rrel</span><span class="p">)</span>
                <span class="c1"># skip start of edge, get metadata, etc. at end of edge</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">outgoing</span> <span class="ow">and</span> <span class="n">rel</span><span class="o">.</span><span class="n">subject</span> <span class="o">==</span> <span class="n">uuid</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="ow">not</span> <span class="n">outgoing</span> <span class="ow">and</span> <span class="n">rel</span><span class="o">.</span><span class="n">object</span> <span class="o">==</span> <span class="n">uuid</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="c1"># add entry in map</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">subject</span> <span class="k">if</span> <span class="n">outgoing</span> <span class="k">else</span> <span class="n">rel</span><span class="o">.</span><span class="n">object</span>
                <span class="n">meta_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">rsrc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">}</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="n">rel</span><span class="o">.</span><span class="n">predicate</span><span class="p">,</span> <span class="n">rel</span><span class="o">.</span><span class="n">object</span><span class="p">,</span> <span class="n">meta_info</span><span class="p">)</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="n">relation_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">relation_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="c1"># print(&#39;@@ built relation map: {}&#39;.format(relation_map))</span>
        <span class="c1"># make sure root node exists</span>
        <span class="k">if</span> <span class="n">id_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">relation_map</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Resource not found: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_</span><span class="p">))</span>
        <span class="c1"># Do a depth-first search through the edges, yield-ing</span>
        <span class="c1"># the relations as we go</span>
        <span class="n">q</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">visited</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">q</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">relation_map</span><span class="p">[</span><span class="n">id_</span><span class="p">])</span>
        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="n">maxdepth</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># print(&#39;@@ depth={:d}. Queue: {}&#39;.format(depth, q))</span>
            <span class="c1"># visit all the nodes in the queue</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">relation</span> <span class="o">=</span> <span class="n">Triple</span><span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">relation</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="n">maxdepth</span><span class="p">:</span>
                    <span class="c1"># Follow relations from subject or object, depending on</span>
                    <span class="c1"># the &quot;direction&quot; that we are searching.</span>
                    <span class="n">next_id</span> <span class="o">=</span> <span class="n">relation</span><span class="o">.</span><span class="n">object</span> <span class="k">if</span> <span class="n">outgoing</span> <span class="k">else</span> <span class="n">relation</span><span class="o">.</span><span class="n">subject</span>
                    <span class="c1"># If there are relations, and we haven&#39;t already been to</span>
                    <span class="c1"># this node, add them at the end of the queue; we will</span>
                    <span class="c1"># visit them at the next depth increment.</span>
                    <span class="k">if</span> <span class="n">next_id</span> <span class="ow">in</span> <span class="n">relation_map</span> <span class="ow">and</span> <span class="n">next_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                        <span class="n">q</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">relation_map</span><span class="p">[</span><span class="n">next_id</span><span class="p">])</span>
                        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">next_id</span><span class="p">)</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span>  <span class="c1"># pop off all the nodes we just visited</span></div>

<div class="viewcode-block" id="ResourceDB.get"><a class="viewcode-back" href="../../../apidoc/idaes.dmf.resourcedb.html#idaes.dmf.resourcedb.ResourceDB.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a resource by identifier.</span>

<span class="sd">        Args:</span>
<span class="sd">          identifier: Internal identifier</span>

<span class="sd">        Returns:</span>
<span class="sd">            (Resource) A resource or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">as_resource</span><span class="p">(</span><span class="n">_r</span><span class="p">):</span>
            <span class="n">rsrc</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">_r</span><span class="p">)</span>
            <span class="n">rsrc</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;doc_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_r</span><span class="o">.</span><span class="n">doc_id</span>
            <span class="k">return</span> <span class="n">rsrc</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_id</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">as_resource</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResourceDB.put"><a class="viewcode-back" href="../../../apidoc/idaes.dmf.resourcedb.html#idaes.dmf.resourcedb.ResourceDB.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Put this resource into the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            resource (Resource): The resource to add</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Raises:</span>
<span class="sd">            errors.DuplicateResourceError: If there is already a resource</span>
<span class="sd">                in the database with the same &quot;id&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check for same id</span>
        <span class="n">qry</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">qry</span><span class="o">.</span><span class="n">id_</span> <span class="o">==</span> <span class="n">resource</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DuplicateResourceError</span><span class="p">(</span><span class="s2">&quot;put&quot;</span><span class="p">,</span> <span class="n">resource</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="c1"># add resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">v</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResourceDB.delete"><a class="viewcode-back" href="../../../apidoc/idaes.dmf.resourcedb.html#idaes.dmf.resourcedb.ResourceDB.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">internal_ids</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete one or more resources with given identifiers.</span>

<span class="sd">        Args:</span>
<span class="sd">            id_ (Union[str,int]): If given, delete this id.</span>
<span class="sd">            idlist (list): If given, delete ids in this list</span>
<span class="sd">            filter_dict (dict): If given, perform a search and</span>
<span class="sd">                           delete ids it finds.</span>
<span class="sd">            internal_ids (bool): If True, treat identifiers as numeric</span>
<span class="sd">                (internal) identifiers. Otherwise treat them as</span>
<span class="sd">                resource (string) indentifiers.</span>
<span class="sd">        Returns:</span>
<span class="sd">            (list[str]) Identifiers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">internal_ids</span><span class="p">:</span>
            <span class="n">doc_ids</span> <span class="o">=</span> <span class="n">idlist</span> <span class="k">if</span> <span class="n">idlist</span> <span class="k">else</span> <span class="p">[</span><span class="n">id_</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">doc_ids</span><span class="o">=</span><span class="n">doc_ids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ID</span> <span class="o">=</span> <span class="n">Resource</span><span class="o">.</span><span class="n">ID_FIELD</span>
            <span class="k">if</span> <span class="n">filter_dict</span><span class="p">:</span>
                <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_expr</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">id_</span><span class="p">:</span>
                <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_expr</span><span class="p">({</span><span class="n">ID</span><span class="p">:</span> <span class="n">id_</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">idlist</span><span class="p">:</span>
                <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_expr</span><span class="p">({</span><span class="n">ID</span><span class="p">:</span> <span class="p">[</span><span class="n">idlist</span><span class="p">]})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cond</span><span class="o">=</span><span class="n">cond</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResourceDB.update"><a class="viewcode-back" href="../../../apidoc/idaes.dmf.resourcedb.html#idaes.dmf.resourcedb.ResourceDB.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">,</span> <span class="n">new_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the identified resource with new values.</span>

<span class="sd">        Args:</span>
<span class="sd">            id_ (int): Identifier of resource to update</span>
<span class="sd">            new_dict (dict): New dictionary of resource values</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If new resource is of wrong type</span>
<span class="sd">            KeyError: If old resource is not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">id_cond</span> <span class="o">=</span> <span class="p">{</span><span class="n">Resource</span><span class="o">.</span><span class="n">ID_FIELD</span><span class="p">:</span> <span class="n">id_</span><span class="p">}</span>
        <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">id_cond</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Cannot find resource id=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_</span><span class="p">))</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">Resource</span><span class="o">.</span><span class="n">TYPE_FIELD</span>
        <span class="k">if</span> <span class="n">old</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_dict</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;New resource type=&quot;</span><span class="si">{}</span><span class="s1">&quot; does not &#39;</span>
                             <span class="s1">&#39;match current resource type &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">old</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">T</span><span class="p">]))</span>

        <span class="n">changed</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">new_dict</span><span class="p">)</span>
                   <span class="k">if</span> <span class="n">old</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="n">v</span><span class="p">}</span>
        <span class="c1"># note: above does not check for missing/new keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">changed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_expr</span><span class="p">(</span><span class="n">id_cond</span><span class="p">))</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2019, David Miller et al.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>